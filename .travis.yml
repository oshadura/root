sudo: required

language: cpp
os: linux
compiler: clang
      
cache:
  ccache: true

branches:
  only:
    - kiryteo-rootbase-cmake
    - Travis*

env:

matrix:
  fast_finish: true

  exclude:
    # Note: Workaround travis-ci/travis-ci#4681
    # Exclude default job which lacks our included environment variables.
    - env:

  include:
    - env: TOOL=clang-format
      script: &format_script
        - if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then .ci/format_script.sh; fi

    - env: TOOL=clang-tidy-analyzer
      before_script: &copy_headers
        - echo "Copying and generating header files."
        - echo -en "travis_fold:start:install.headers"
        - .ci/copy_headers.sh
        - echo -en 'travis_fold:end:install.headers\\r'

      script: &tidy_script
        - |
          if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then
            .ci/tidy_script.sh
          fi

    - env: TOOL=clang-tidy-modernize
      before_script: *copy_headers
      script: *tidy_script

    - env: TOOL=minuit2-standalone
      script: cd math/minuit2 && .ci/make_and_test.sh


    - env: TOOL=cmake-build
      addons:
        apt:
          sources: *sources
          packages:
            - cmake-data
            - cmake

    before_install:
    - sudo apt-get -qq update
    - sudo sh -c "echo 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-5.0 main' >> /etc/apt/sources.list"
    - wget -O - http://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
    - sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test

    install:
    -
    for i in {1..5}; do
      if sudo apt-get update && sudo apt-get install -y --force-yes llvm-5.0 llvm-5.0-dev clang-5.0; then
        break;
      fi;
      sleep 1;
    done

#  - sudo apt-get update && sudo apt-get install -y --force-yes llvm-5.0 llvm-5.0-dev clang-5.0

    before_script:
      - mkdir ../builds
      - cd ../builds

    script:
      - cmake -DCMAKE_CXX_STANDARD=14 -Dbuiltin_llvm=off ../root
      - make
      - sudo make install

  allow_failures:
    # clang-tidy-modernize is still experimental
    - env: TOOL=clang-tidy-modernize
    # a lot of code doesn't follow clang-format yet
    - env: TOOL=clang-format


# This will never run since there is not a clang-tidy only TOOL
#  elif [[ "$TRAVIS_EVENT_TYPE" = "cron" ]] && [[ $TOOL == 'clang-tidy' ]]; then
#    # We need to ignore our vendor drops.
#    FILES_REGEX='^.*root\/(?!interpreter\/|core\/clib)'
#
#    echo "Running clang-tidy-3.9 against branch $TRAVIS_BRANCH."
#    echo "run-clang-tidy-3.9.py -j4 -clang-tidy-binary $(which clang-tidy-3.9) -checks=-*,clang-analyzer-* $FILES_REGEX"
#    run-clang-tidy-3.9.py -j4 -clang-tidy-binary $(which clang-tidy-3.9) -checks=-*,clang-analyzer-* $FILES_REGEX
#  fi

on_failure: echo "Showing current directory contents" && ls -la
